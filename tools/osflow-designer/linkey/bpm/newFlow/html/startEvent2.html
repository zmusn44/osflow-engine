<!DOCTYPE html>
<html>
 <head>
  <title>节点属性</title> 
  <style>
  </style>
  <meta charset="UTF-8" /> 
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../layui/css/layui.css"  media="all">
  
  <script src="../layui/layui.js" charset="utf-8"></script>
<script type="text/javascript" src="../../easyui/jquery.min.js"></script>
  <script type="text/javascript" src="../../jscode/sharefunction.js"></script>
  <script>function formonload() {
	  var Nodeid = GetUrlArg("Nodeid");
	  $("#Nodeid").html(Nodeid);
	  $('#event').attr("src","../view/startEventView.html?WF_Action=edit&WF_DocUnid=&Processid="+ GetUrlArg("Processid") +"&Nodeid="+ GetUrlArg("Nodeid") +"&NodeType="+ GetUrlArg("ExtNodeType") +"&WF_Appid=S029")
	  $.ajax({
          async:false,
          type:"post",
          url:"../../../../rule?wf_num=getFlowChartModByNodeType&Processid="+GetUrlArg("Processid") + "&Nodeid=" + GetUrlArg("Nodeid"),
          dataType:"json",
          success:function(data){
        	  for(var key in data['基本属性']){
   		　　　	$('#'+key).val(data['基本属性'][key]);
      		　}
          }
      });
  }
  function myBrowser() {
	    var userAgent = navigator.userAgent;
	    var isOpera = userAgent.indexOf("Opera") > -1;
	    if (isOpera) {
	        return "Opera"
	    };
	    if (userAgent.indexOf("Firefox") > -1) {
	        return "FF";
	    }
	    if (userAgent.indexOf("Chrome") > -1) {
	        return "Chrome";
	    }
	    if (userAgent.indexOf("Safari") > -1) {
	        return "Safari";
	    }
	    if ( !! window.ActiveXObject || "ActiveXObject" in window) {
	        if (navigator.appVersion.split(";")[1].replace(/[ ]/g, "") == "MSIE10.0") {
	            return "IE10"
	        }
	        return "IE"
	    };
	}
	function SaveDocument(btnAction) {
		var map = {};
		if(!$("#NodeName").val()){
	    	$("#NodeName").next().show();
	    	$("#tabs").tabs("select",0);
	    	return false;
	    }else {
	    	$("#NodeName").next().hide();
	    }
	    $("input").each(function(){
	        var input = $(this);
	        if(input.attr("id")!==undefined)
	        map[input.attr("id")] = input.val();
	    });
	    var postData = {
	    	"json":JSON.stringify(map)
	    }
	    mask();
	    $.post("../../../../rule?wf_num=saveFlowChartModByNodeType&Processid="+GetUrlArg("Processid") + "&Nodeid=" + GetUrlArg("Nodeid")+ "&ExtNodeType=" + GetUrlArg("ExtNodeType"),
   			postData, function(data) {
   	        unmask();
   	        if (data.Status == "error") {
   	            $.messager.alert("Info", data.msg, "Error");
   	        } else {
   	            var NodeName = $("#NodeName").val();
   	            var Nodeid = GetUrlArg("Nodeid");
   	            if (Nodeid != "Process") {
   	                if (opener) {
   	                    opener.SetPropertyVal(Nodeid, NodeName);
   	                } else {
   	                    window.dialogArguments.SetPropertyVal(Nodeid, NodeName);
   	                }
   	            }
   	            if (btnAction == "quit") {
   	                window.close();
   	            }
   	        }
   	    });
	}
</script>
  <script>
  layui.use(['element','table','form'], function(){
	  var delRow = [];
	  var editRow = [];
	  var $ = layui.jquery
	  ,element = layui.element; //Tab的切换功能，切换事件监听等，需要依赖element模块
	  var form = layui.form;
	  var table = layui.table;
	  //触发事件
	  var active = {
	    insertRow: function(){ //获取选中数据
	    	var dataBak = [];   //定义一个空数组,用来存储之前编辑过的数据已经存放新数据
	    	var tableBak = table.cache.event; 
	    	for (var i = 0; i < tableBak.length; i++) {
	    	    dataBak.push(tableBak[i]);      //将之前的数组备份
	    	}	
	    	dataBak.push({   
	    	    "Eventid": ""
	    	    ,"Nodeid": GetUrlArg("Nodeid")
	    	    ,"Processid": GetUrlArg("Processid")
	    	    ,"RuleNum": ""
	    	    ,"SortNum": ""
	    	    ,"WF_AddName" : ""
	    	    ,"WF_LastModified" : ""
	    	    ,"WF_OrUnid" : ""
	    	});
	    	table.reload("event",{
	    	    data:dataBak   // 将新数据重新载入表格
	    	})
	      }
	      ,saveRow: function(){ //保存事件
	    	  	var data = table.cache.event;
	    	  	var newRow = [];
	    	  	var editRow = [];
	    	  	for(var i = 0; i < data.length; i++){
	    	  		if(data[i].WF_OrUnid) editRow.push(data[i]);
	    	  		else newRow.push(data[i]);
	    	  	}
	    	  	console.dir(data);
	        	$.ajax({
        			url:"../../../../rule?wf_num=saveFlowChartEventByNodeType&Processid="+ GetUrlArg("Processid") +"&Nodeid="+GetUrlArg("Nodeid"),
        			type:"Post",
        			data : {WF_Action:'saveEditor',delRow:JSON.stringify(delRow),newRow:JSON.stringify(newRow),editRow:JSON.stringify(editRow)},
        			dateType:"json",
        			traditional: true,
        			success : function(data){
	                	
        			}
	            });
	      }
	    };
	  $('.demoTable .layui-btn').on('click', function(){
		    var type = $(this).data('type');
		    active[type] ? active[type].call(this) : '';
	  })
	//展示已知数据
	  table.render({
	    elem: '#event'
	    ,cols: [[ //标题栏
	      {type:'checkbox'}
	      ,{field:'Eventid',title:'对应事件id', minWidth:180,templet: '#selectEventid',sort:false}
	      ,{field:'RuleNum',title:'触发规则', minWidth:150,  edit: 'text'}
	      ,{field:'Params',title:'规则参数', minWidth:150, edit: 'text'}
	      ,{field:'SortNum',title:'排序号', minWidth:150,  edit: 'text'}
	      ,{title:'操作',fixed: 'right', width:178, align:'center', toolbar: '#barDemo'}
	    ]],
	    height: 'full-50',
	    data:getData(),
	    done: function (res, curr, count) {
            $.ajax({
                //拼接下拉选项
                type: "post",
                url: "../json/startEvent.json",
                dataType: "json",
                success: function (data) {
                    for (var i in data) {
                        $("select[name='Eventid']").append('<option value=""+data[i].Eventid+"" {{# if(d.Eventid=="+data[i].Eventid+"){ }} selected=\"selected\" {{# } }}>'+data[i].EventName+'</option>');
                    }
                    $(".layui-table-body, .layui-table-box, .layui-table-cell").css('overflow', 'visible');
                    form.render('select');
                }
            });
	    }
	});
	//监听工具条
	  table.on('tool(event)', function(obj){
	    var data = obj.data;
	    if(obj.event === 'del'){
	        layer.confirm('真的删除行么', function(index){
	        	if(obj.data.WF_OrUnid){
		        	delRow.push(obj.data);
	        	}
	          	obj.del();
	          	layer.close(index);
	        });
	      }
	  });
	  form.on('select(Eventid)', function (data) {
          var elem = $(data.elem);
          var trElem = elem.parents('tr');
          var tableData = table.cache.event;
          // 更新到表格的缓存数据中，才能在获得选中行等等其他的方法中得到更新之后的值
          tableData[trElem.data('index')][elem.attr('name')] = data.value;
          // 其他的操作看需求 TODO
      });
  	function getData(){
  		var rows;
	  	$.ajax({
	        url:"../../../../rule?wf_num=getFlowChartEventByNodeType&Processid="+ GetUrlArg("Processid") +"&Nodeid="+GetUrlArg("Nodeid"),
	        type:"Post",
	        async : false,
	        dataType:"json",
	        success:function(data){
	      	  rows = data.rows;
	        },
	        error:function(data){
	            $.messager.alert('错误',data.msg);
	        }
	  	})
	  return rows;
    }	
  })
  </script>
 </head>
 <body style="margin:0px;overflow:hidden">
  <div class="layui-tab" >
	  <ul class="layui-tab-title">
	    <li class="layui-this">基本属性</li>
	    <li>事件设置</li>
	  </ul>
	  <div class="layui-tab-content" style="height: 100px;">
	    <div class="layui-tab-item layui-show">
            <form class="layui-form" id="form1">
				<div class="layui-form-item">
                    <label class="layui-form-label">节点名称</label>
                    <div class="layui-input-block">
                        <input id="NodeName" type="text" name="NodeName" value="开始" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">节点id</label>
                    <div class="layui-input-block">
                        <input id="Nodeid" readonly="" name="Nodeid" value="E00001" class="layui-input">                          </div>
                </div>
		    </form>
		</div>
		
	    <div class="layui-tab-item">
		    <div class="layui-btn-group demoTable">
			  <button class="layui-btn" data-type="saveRow">保存事件</button>
			  <button class="layui-btn" data-type="insertRow">新增事件</button>
			</div>
			<table class="layui-table" id="event" lay-filter="event"></table>
			<script type="text/html" id="selectEventid">
   				 <select name="Eventid" lay-filter="Eventid" data-value="{{d.Eventid}}"></select>
			</script>
			<script type="text/html" id="barDemo">
  				<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
			</script>
		</div>
	</div> 
  </div>
 </body>
</html>